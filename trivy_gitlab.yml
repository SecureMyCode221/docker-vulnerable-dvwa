Trivy_container_scanning:
  stage: test
  image: docker:stable
  services:
  - name: docker:dind
    entrypoint: ["env", "-u", "DOCKER_HOST"]
    command: ["dockerd-entrypoint.sh"]
  allow_failure: false
   
  before_script:
    - apk add --no-cache curl docker-cli
    - docker build -t docker.io/sdevsecops221/docker-vulnerable-dvwa:$CI_COMMIT_SHA .
    - curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v0.24.1

  script:  
    - trivy image --format sarif --output trivy-results.sarif --exit-code 0   docker.io/sdevsecops221/docker-vulnerable-dvwa:$CI_COMMIT_SHA
  
  artifacts:
    when: always
    paths:
    - trivy-results.sarif
